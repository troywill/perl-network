#!/usr/bin/env perl
use warnings;
use strict;
use constant WIRELESS_FILE => '/usr/local/etc/wireless/00';
use constant WIRELESS_INTERFACE => 'wlan0';
my $SCAN_COMMAND = "iwlist " . WIRELESS_INTERFACE . " scanning";
my @scan = `$SCAN_COMMAND`;

my ( %known_macs, %known_essids ) = &known_networks();
my %available_macs = &available_networks(@scan);

foreach my $mac ( keys %known_macs ) {
    print "==> $mac $known_macs{$mac}{essid}\n";
    print "Check $mac to see if it is in 'available_macs' hash ...\n";
    if ( $available_macs{$mac} ) {
	print "DEBUG\n";
	print "$available_macs{$mac}{essid} FOUND\n";
    }
}

sub known_networks {
    my %HoN;
    open my $fh, "<", WIRELESS_FILE;
    while (<$fh>) {
	chomp;
	my ( $mac, $essid, $key, $security_type ) = split /,/;
	$HoN{$mac}{essid} = $essid;
	print "DEBUG: $mac $essid $key\n";
	$HoN{$mac}{key} = $key;
    }
    return ( %HoN, %HoN );
}

sub available_networks {
  my @scan = @_;
  my ( %cell, %HoC, $mac, $security_type );
  foreach (@scan) {
    if ( m/^\s+Cell\s+\d+\s+-*\s*Address:\s*(([0-9a-fA-F]{2}[:-]{1}){5}([0-9a-fA-F]{2}))/ ) {
      $mac = $1;
      %cell = ( mac  => $mac );
      $security_type = '';
    } elsif (m/^\s*ESSID:*\"(.*?)\"/ ) {
      $HoC{$mac}{essid} = $1;
    } elsif ( m/^\s*Quality=(\d+)\/(\d+)\s*/ ) {
      $HoC{$mac}{quality} = $1;
    } elsif ( m/^\s*Encryption key:(.*?)$/ ) {
      $HoC{$mac}{encryption} = $1;
      # security type
    } elsif ( m/IEEE 802.11i\/WPA2 Version 1/ ) {
      $security_type .= "[WPA2]";
      $HoC{$mac}{security} = $security_type;
    } elsif ( m/WPA Version 1/ ) {
      $security_type .= "[WPA]";
      $HoC{$mac}{security} = $security_type;
    }
  }
  return %HoC;
}    
print `date`;
__END__


    &display_sort;
  sub display_sort {
    my ( $mac, $strength, $essid, $security );
    format STDOUT_TOP =
hardware address  strength Network name             Security Type
----------------- -------- ----------------------   -------------
.

      format STDOUT =
@<<<<<<<<<<<<<<<< @>>>>>>> @<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<@<<<<<<<<<<<<<<<
$mac,           $strength,  $essid, $security
.

      foreach $mac ( sort { $HoC{$b}{Quality} <=> $HoC{$a}{Quality} } keys %HoC ) {

	$strength = $HoC{$mac}{Quality};
	$essid = "'" . $HoC{$mac}{ESSID} . "'";
	if ( $HoC{$mac}{security} ) {
	  $security = $HoC{$mac}{security};
	} elsif ( $HoC{$mac}{Encryption} eq 'off' ) {
	  $security = "[open network]";
	} else {
	  $security = "WEP";
	}
	write;
      }
    ;

  }
