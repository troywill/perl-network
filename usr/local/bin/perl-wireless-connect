#!/usr/bin/env perl
use warnings;
use strict;
use constant WIRELESS_FILE => '/usr/local/etc/wireless/00';
use constant WIRELESS_INTERFACE => 'wlan0';
my $WIRELESS_INTERFACE = 'wlan0';
my $SUDO = &get_sudo('/usr/bin/sudo');
my $SCAN_COMMAND = "${SUDO} iwlist ${WIRELESS_INTERFACE} scanning";

my ( %known_macs ) = &read_known_networks();
print "=> Scanning for available networks ...\n";
my @network_scan = `$SCAN_COMMAND`;
my %available_macs = &available_networks(@network_scan);

foreach my $mac ( keys %known_macs ) {
  if ( $available_macs{$mac} ) {
    print "=> Network '$available_macs{$mac}{essid}' found...\n";
    &connect_to_network( $mac, \%known_macs, \%available_macs );
  }
}

print `date`;

sub connect_to_network {
  # %HoH is hash of available wireless cell hashes from external program ( iwlist scanning )
  my ( $mac, $known_macs_ref, $HoH_ref ) = @_;
  my %known_macs_ref = %{$known_macs_ref};
  my %HoH = %{$HoH_ref};
  print "ESSID: $HoH{$mac}{essid}\n";
  print "ENCRYPTION: $HoH{$mac}{encryption}\n";
  print "QUALITY: $HoH{$mac}{quality}\n";
  print "SECURITY: $HoH{$mac}{security}\n";
  if ( $HoH{$mac}{security} eq 'WEP') {
      my $key = $known_macs{$mac}{key};
      &connect_to_wep( $key, $HoH{$mac}{essid} );
  }
}

sub connect_to_wep {
    my ($key, $essid) = @_;
    print "DEBUG: Do not connect if connected!!!!\n";
    print "[$key][$essid]\n";
    system("/usr/sbin/iwconfig wlan0 key $key");
    system("/usr/sbin/iwconfig wlan0 essid $essid");
    system("dhcpcd wlan0");
}

# Read mac, essid from file
sub read_known_networks {
  my %HoN;
  open my $fh, "<", WIRELESS_FILE;
  while (<$fh>) {
    chomp;
    my ( $mac, $essid, $key, $security_type ) = split /,/;
    $HoN{$mac}{essid} = $essid;
    $HoN{$mac}{key} = $key;
  }
  close $fh;
  return ( %HoN );
}

sub available_networks {
  my @scan = @_;
  my ( %cell, %HoC, $mac, $security_type );
  foreach (@scan) {
    if ( m/^\s+Cell\s+\d+\s+-*\s*Address:\s*(([0-9a-fA-F]{2}[:-]{1}){5}([0-9a-fA-F]{2}))/ ) {
      $mac = $1;
      %cell = ( mac  => $mac );
      $security_type = '';
    } elsif (m/^\s*ESSID:*\"(.*?)\"/ ) {
      $HoC{$mac}{essid} = $1;
    } elsif ( m/^\s*Quality=(\d+)\/(\d+)\s*/ ) {
      $HoC{$mac}{quality} = $1;
    } elsif ( m/^\s*Encryption key:(.*?)$/ ) {
      $HoC{$mac}{encryption} = $1;
      # security type
    } elsif ( m/IEEE 802.11i\/WPA2 Version 1/ ) {
      $security_type .= "[WPA2]";
      $HoC{$mac}{security} = $security_type;
    } elsif ( m/WPA Version 1/ ) {
      $security_type .= "[WPA]";
      $HoC{$mac}{security} = $security_type;
    }
  }
  # iwlist scanning does not indicate explicitly when a network is using WEP security
  # Let's deduce this by checking if security is on and WPA or WPA are not involved
  foreach $mac ( keys %HoC ) {
    if ( $HoC{$mac}{security} ) {
    } elsif ( $HoC{$mac}{encryption} eq 'off' ) {
      $HoC{$mac}{security} = 'off';
    } else {
      $HoC{$mac}{security} = 'WEP';
    }
  }
  return %HoC;
}    

sub get_sudo {
    my $sudo_binary = shift;
    my $sudo = '';
    unless ( $ENV{USER} eq 'root' ) {
	$sudo = $sudo_binary if ( -e $sudo_binary );
    }
    return $sudo;
}
