#!/usr/bin/env perl
use warnings;
use strict;
use constant WIRELESS_FILE => '/usr/local/etc/wireless/00';
use constant WIRELESS_INTERFACE => 'wlan0';
my $SCAN_COMMAND = "iwlist " . WIRELESS_INTERFACE . " scanning";
my ( %cell, %HoC, $mac, $security_type );
open my $fh, "<", WIRELESS_FILE;
while (<$fh>) {
  chomp;
  my ( $mac, $essid, $key, $security_type ) = split /,/;
}

my @scan = `$SCAN_COMMAND`;
&form_hash(@scan);
print %HoC;

sub form_hash {
  my @scan = @_;
  foreach (@scan) {
    print "."; sleep 1;
    if ( m/^\s+Cell\s+\d+\s+-*\s*Address:\s*(([0-9a-fA-F]{2}[:-]{1}){5}([0-9a-fA-F]{2}))/ ) {
      $mac = $1;
      %cell = ( mac  => $mac );
      $security_type = '';
    } elsif (m/^\s*ESSID:*\"(.*?)\"/ ) {
      $HoC{$mac}{ESSID} = $1;
    } elsif ( m/^\s*Quality=(\d+)\/(\d+)\s*/ ) {
      $HoC{$mac}{Quality} = $1;
    } elsif ( m/^\s*Encryption key:(.*?)$/ ) {
      $HoC{$mac}{Encryption} = $1;
      # security type
    } elsif ( m/IEEE 802.11i\/WPA2 Version 1/ ) {
      $security_type .= "[WPA2]";
      $HoC{$mac}{security} = $security_type;
    } elsif ( m/WPA Version 1/ ) {
      $security_type .= "[WPA]";
      $HoC{$mac}{security} = $security_type;
    }
  }
}    
__END__


    &display_sort;
  sub display_sort {
    my ( $mac, $strength, $essid, $security );
    format STDOUT_TOP =
hardware address  strength Network name             Security Type
----------------- -------- ----------------------   -------------
.

      format STDOUT =
@<<<<<<<<<<<<<<<< @>>>>>>> @<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<@<<<<<<<<<<<<<<<
$mac,           $strength,  $essid, $security
.

      foreach $mac ( sort { $HoC{$b}{Quality} <=> $HoC{$a}{Quality} } keys %HoC ) {

	$strength = $HoC{$mac}{Quality};
	$essid = "'" . $HoC{$mac}{ESSID} . "'";
	if ( $HoC{$mac}{security} ) {
	  $security = $HoC{$mac}{security};
	} elsif ( $HoC{$mac}{Encryption} eq 'off' ) {
	  $security = "[open network]";
	} else {
	  $security = "WEP";
	}
	write;
      }
    ;

  }
